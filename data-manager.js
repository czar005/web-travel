// Unified Data Manager - handles all data operations
class DataManager {
    constructor() {
        this.storageKey = 'worldtravel_data';
        this.init();
    }

    init() {
        console.log('üöÄ DataManager initialized');
        this.ensureDefaultData();
    }

    ensureDefaultData() {
        let data = this.getData();
        if (!data) {
            data = this.getDefaultData();
            this.setData(data);
            console.log('üìù Default data created');
        } else if (!data.countries) {
            data.countries = this.getDefaultData().countries;
            this.setData(data);
            console.log('üìù Countries array added to existing data');
        }
        return data;
    }

    getDefaultData() {
        return {
            countries: [
                {
                    id: 1,
                    name: "–¢—É—Ä—Ü–∏—è",
                    description: "–°—Ç—Ä–∞–Ω–∞ –Ω–∞ —Å—Ç—ã–∫–µ –ï–≤—Ä–æ–ø—ã –∏ –ê–∑–∏–∏ —Å –±–æ–≥–∞—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–º–∏ –ø–ª—è–∂–∞–º–∏ –°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—å—è.",
                    image: "https://images.unsplash.com/photo-1578683010236-d716f9a3f461?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80",
                    flag: "üáπüá∑",
                    popular: true,
                    season: "–ö—Ä—É–≥–ª—ã–π –≥–æ–¥",
                    tours: [
                        { id: 1, name: "–ê–Ω—Ç–∞–ª–∏—è - –í—Å–µ –≤–∫–ª—é—á–µ–Ω–æ", price: "45,000 ‚ÇΩ", duration: "7 –Ω–æ—á–µ–π", rating: 4.8 },
                        { id: 2, name: "–°—Ç–∞–º–±—É–ª - –ì–æ—Ä–æ–¥ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–≤", price: "38,000 ‚ÇΩ", duration: "5 –Ω–æ—á–µ–π", rating: 4.6 }
                    ]
                },
                {
                    id: 2,
                    name: "–ï–≥–∏–ø–µ—Ç",
                    description: "–î—Ä–µ–≤–Ω—è—è —Å—Ç—Ä–∞–Ω–∞ –ø–∏—Ä–∞–º–∏–¥, —Ñ–∞—Ä–∞–æ–Ω–æ–≤ –∏ –∫—Ä–∞—Å–æ—á–Ω—ã—Ö –∫–æ—Ä–∞–ª–ª–æ–≤—ã—Ö —Ä–∏—Ñ–æ–≤ –ö—Ä–∞—Å–Ω–æ–≥–æ –º–æ—Ä—è.",
                    image: "https://images.unsplash.com/photo-1539650116574-75c0c6d73f7e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80",
                    flag: "üá™üá¨",
                    popular: true,
                    season: "–û–∫—Ç—è–±—Ä—å - –ê–ø—Ä–µ–ª—å",
                    tours: [
                        { id: 1, name: "–•—É—Ä–≥–∞–¥–∞ - –î–∞–π–≤–∏–Ω–≥ —Ç—É—Ä", price: "52,000 ‚ÇΩ", duration: "8 –Ω–æ—á–µ–π", rating: 4.9 },
                        { id: 2, name: "–®–∞—Ä–º-—ç–ª—å-–®–µ–π—Ö - –†–∞–π—Å–∫–∏–π –æ—Ç–¥—ã—Ö", price: "48,000 ‚ÇΩ", duration: "7 –Ω–æ—á–µ–π", rating: 4.7 }
                    ]
                },
                {
                    id: 3,
                    name: "–¢–∞–∏–ª–∞–Ω–¥",
                    description: "–≠–∫–∑–æ—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∞ —É–ª—ã–±–æ–∫, –¥—Ä–µ–≤–Ω–∏—Ö —Ö—Ä–∞–º–æ–≤ –∏ —Ç—Ä–æ–ø–∏—á–µ—Å–∫–∏—Ö –æ—Å—Ç—Ä–æ–≤–æ–≤.",
                    image: "https://images.unsplash.com/photo-1528181304800-259b08848526?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80",
                    flag: "üáπüá≠",
                    popular: true,
                    season: "–ù–æ—è–±—Ä—å - –§–µ–≤—Ä–∞–ª—å",
                    tours: [
                        { id: 1, name: "–ü—Ö—É–∫–µ—Ç - –ü–ª—è–∂–Ω—ã–π —Ä–∞–π", price: "65,000 ‚ÇΩ", duration: "10 –Ω–æ—á–µ–π", rating: 4.8 },
                        { id: 2, name: "–ë–∞–Ω–≥–∫–æ–∫ - –°—Ç–æ–ª–∏—Ü–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–≤", price: "58,000 ‚ÇΩ", duration: "8 –Ω–æ—á–µ–π", rating: 4.5 }
                    ]
                },
                {
                    id: 4,
                    name: "–ò—Ç–∞–ª–∏—è",
                    description: "–ö–æ–ª—ã–±–µ–ª—å –∏—Å–∫—É—Å—Å—Ç–≤–∞, –º–æ–¥—ã –∏ —Å–∞–º–æ–π –≤–∫—É—Å–Ω–æ–π –∫—É—Ö–Ω–∏ –≤ —Å–µ—Ä–¥—Ü–µ –°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—å—è.",
                    image: "https://images.unsplash.com/photo-1515542622106-78bda8ba0e5b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80",
                    flag: "üáÆüáπ",
                    popular: false,
                    season: "–ê–ø—Ä–µ–ª—å - –û–∫—Ç—è–±—Ä—å",
                    tours: [
                        { id: 1, name: "–†–∏–º - –í–µ—á–Ω—ã–π –≥–æ—Ä–æ–¥", price: "78,000 ‚ÇΩ", duration: "6 –Ω–æ—á–µ–π", rating: 4.9 },
                        { id: 2, name: "–í–µ–Ω–µ—Ü–∏—è - –ì–æ—Ä–æ–¥ –Ω–∞ –≤–æ–¥–µ", price: "82,000 ‚ÇΩ", duration: "5 –Ω–æ—á–µ–π", rating: 4.7 }
                    ]
                },
                {
                    id: 5,
                    name: "–ò—Å–ø–∞–Ω–∏—è",
                    description: "–°—Ç—Ä–∞–Ω–∞ —Ñ–ª–∞–º–µ–Ω–∫–æ, –∫–æ—Ä—Ä–∏–¥—ã –∏ —Å–æ–ª–Ω–µ—á–Ω—ã—Ö –ø–ª—è–∂–µ–π –ö–æ—Å—Ç–∞-–ë—Ä–∞–≤–∞.",
                    image: "https://images.unsplash.com/photo-1543785734-4b6e564642f8?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80",
                    flag: "üá™üá∏",
                    popular: false,
                    season: "–ú–∞–π - –°–µ–Ω—Ç—è–±—Ä—å",
                    tours: [
                        { id: 1, name: "–ë–∞—Ä—Å–µ–ª–æ–Ω–∞ - –°—Ç–æ–ª–∏—Ü–∞ –ö–∞—Ç–∞–ª–æ–Ω–∏–∏", price: "68,000 ‚ÇΩ", duration: "7 –Ω–æ—á–µ–π", rating: 4.8 },
                        { id: 2, name: "–ú–∞–¥—Ä–∏–¥ - –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –≥–æ—Ä–æ–¥", price: "72,000 ‚ÇΩ", duration: "6 –Ω–æ—á–µ–π", rating: 4.6 }
                    ]
                },
                {
                    id: 6,
                    name: "–û–ê–≠",
                    description: "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ–≥–∞–ø–æ–ª–∏—Å—ã, —Ä–æ—Å–∫–æ—à–Ω—ã–µ –æ—Ç–µ–ª–∏ –∏ –∑–æ–ª–æ—Ç—ã–µ –ø—É—Å—Ç—ã–Ω–∏ –ê—Ä–∞–≤–∏–∏.",
                    image: "https://images.unsplash.com/photo-1512453979798-5ea266f8880c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80",
                    flag: "üá¶üá™",
                    popular: true,
                    season: "–û–∫—Ç—è–±—Ä—å - –ê–ø—Ä–µ–ª—å",
                    tours: [
                        { id: 1, name: "–î—É–±–∞–π - –ì–æ—Ä–æ–¥ –±—É–¥—É—â–µ–≥–æ", price: "89,000 ‚ÇΩ", duration: "7 –Ω–æ—á–µ–π", rating: 4.9 },
                        { id: 2, name: "–ê–±—É-–î–∞–±–∏ - –°—Ç–æ–ª–∏—Ü–∞ —ç–º–∏—Ä–∞—Ç–æ–≤", price: "85,000 ‚ÇΩ", duration: "6 –Ω–æ—á–µ–π", rating: 4.7 }
                    ]
                }
            ],
            contacts: {
                phone: "+7 (999) 123-45-67",
                email: "info@worldtravel.com",
                address: "–ú–æ—Å–∫–≤–∞, —É–ª. –¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è, 15",
                hours: "–ü–Ω-–ü—Ç: 9:00-18:00"
            },
            content: {
                hero: {
                    title: "–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏—Ä —Å WorldTravel",
                    subtitle: "–ú—ã —Å–æ–∑–¥–∞–µ–º –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É. –û—Ç —ç–∫–∑–æ—Ç–∏—á–µ—Å–∫–∏—Ö –ø–ª—è–∂–µ–π –¥–æ –≥–æ—Ä–Ω—ã—Ö –≤–µ—Ä—à–∏–Ω - –≤–∞—à–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–¥–µ—Å—å.",
                    image: "images/travel-placeholder.svg"
                },
                about: {
                    title: "–û –Ω–∞—Å",
                    description: "WorldTravel - —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –∏ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –ø–æ —Ç—É—Ä–∏–∑–º—É —Å –±–æ–ª–µ–µ —á–µ–º 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã. –ú—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö travel-—Ä–µ—à–µ–Ω–∏–π.",
                    image: "images/travel-placeholder.svg",
                    stats: [
                        { value: "5000", label: "–î–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤" },
                        { value: "50", label: "–°—Ç—Ä–∞–Ω –º–∏—Ä–∞" },
                        { value: "10 –ª–µ—Ç", label: "–û–ø—ã—Ç–∞ —Ä–∞–±–æ—Ç—ã" }
                    ]
                },
                services: {
                    title: "–£—Å–ª—É–≥–∏",
                    services: [
                        { title: "–ê–≤–∏–∞–±–∏–ª–µ—Ç—ã", description: "–ü–æ–¥–±–æ—Ä –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ª—É—á—à–∏—Ö –∞–≤–∏–∞–ø–µ—Ä–µ–ª–µ—Ç–æ–≤ –ø–æ –≤—ã–≥–æ–¥–Ω—ã–º —Ü–µ–Ω–∞–º", icon: "fas fa-plane" },
                        { title: "–û—Ç–µ–ª–∏", description: "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–µ–ª–µ–π –ª—é–±–æ–≥–æ —É—Ä–æ–≤–Ω—è –∫–æ–º—Ñ–æ—Ä—Ç–∞ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É", icon: "fas fa-hotel" },
                        { title: "–¢—É—Ä—ã", description: "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∏ –≥—Ä—É–ø–ø–æ–≤—ã–µ —Ç—É—Ä—ã —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –≥–∏–¥–∞–º–∏", icon: "fas fa-map-marked-alt" },
                        { title: "–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ", description: "–ü–æ–ª–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", icon: "fas fa-shield-alt" }
                    ]
                },
                destinations: {
                    title: "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
                    subtitle: "–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –ª—É—á—à–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏—Ä–∞ —Å –Ω–∞—à–∏–º–∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–º–∏ —Ç—É—Ä–∞–º–∏"
                },
                contact: {
                    title: "–ö–æ–Ω—Ç–∞–∫—Ç—ã"
                }
            },
            footer: {
                description: "–í–∞—à –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä –≤ –º–∏—Ä–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π.",
                copyright: "&copy; 2024 WorldTravel. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã."
            },
            settings: {
                siteTitle: "WorldTravel - –¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è",
                companyName: "WorldTravel"
            },
            pageStructure: ["hero", "about", "services", "destinations", "contact"],
            lastUpdate: new Date().toISOString()
        };
    }

    // Core data methods
    getData() {
        try {
            const data = localStorage.getItem(this.storageKey);
            if (!data) return null;
            
            const parsed = JSON.parse(data);
            if (!parsed.countries) {
                parsed.countries = [];
            }
            return parsed;
        } catch (error) {
            console.error('‚ùå Error reading data:', error);
            return null;
        }
    }

    setData(data) {
        try {
            if (!data.countries) {
                data.countries = [];
            }
            
            data.lastUpdate = new Date().toISOString();
            localStorage.setItem(this.storageKey, JSON.stringify(data));
            
            const event = new CustomEvent('worldtravelDataUpdated', { 
                detail: { data: data, timestamp: data.lastUpdate }
            });
            window.dispatchEvent(event);
            
            console.log('üíæ Data saved successfully');
            return true;
        } catch (error) {
            console.error('‚ùå Error saving data:', error);
            return false;
        }
    }

    // Country management
    getCountries() {
        const data = this.getData();
        return data?.countries || [];
    }

    addCountry(countryData) {
        const data = this.getData();
        if (!data) {
            console.error('‚ùå No data available');
            return false;
        }

        if (!Array.isArray(data.countries)) {
            data.countries = [];
        }

        const newCountry = {
            id: Date.now(),
            name: countryData.name,
            description: countryData.description,
            image: countryData.image || "https://images.unsplash.com/photo-1488646953014-85cb44e25828?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1200&q=80",
            flag: countryData.flag || "üá∫üá≥",
            popular: countryData.popular || false,
            season: countryData.season || "–ö—Ä—É–≥–ª—ã–π –≥–æ–¥",
            tours: []
        };

        data.countries.push(newCountry);
        return this.setData(data);
    }

    updateCountry(countryId, countryData) {
        const data = this.getData();
        if (!data) return false;

        if (!Array.isArray(data.countries)) {
            data.countries = [];
            return false;
        }

        const countryIndex = data.countries.findIndex(c => c.id === countryId);
        if (countryIndex === -1) return false;

        data.countries[countryIndex] = { ...data.countries[countryIndex], ...countryData };
        return this.setData(data);
    }

    deleteCountry(countryId) {
        const data = this.getData();
        if (!data) return false;

        if (!Array.isArray(data.countries)) {
            data.countries = [];
            return false;
        }

        data.countries = data.countries.filter(c => c.id !== countryId);
        return this.setData(data);
    }

    // Tour management
    getAllTours() {
        const countries = this.getCountries();
        const allTours = [];
        
        countries.forEach(country => {
            if (country.tours && Array.isArray(country.tours)) {
                country.tours.forEach(tour => {
                    allTours.push({
                        ...tour,
                        countryId: country.id,
                        countryName: country.name,
                        countryImage: country.image,
                        countryFlag: country.flag
                    });
                });
            }
        });
        
        return allTours;
    }

    addTour(countryId, tourData) {
        const data = this.getData();
        if (!data) return false;

        if (!Array.isArray(data.countries)) {
            data.countries = [];
            return false;
        }

        const country = data.countries.find(c => c.id === countryId);
        if (!country) return false;

        if (!Array.isArray(country.tours)) {
            country.tours = [];
        }

        const newTour = {
            id: Date.now(),
            name: tourData.name,
            price: tourData.price,
            duration: tourData.duration,
            rating: tourData.rating || 4.5
        };

        country.tours.push(newTour);
        return this.setData(data);
    }

    deleteTour(countryId, tourId) {
        const data = this.getData();
        if (!data) return false;

        if (!Array.isArray(data.countries)) {
            data.countries = [];
            return false;
        }

        const country = data.countries.find(c => c.id === countryId);
        if (!country || !Array.isArray(country.tours)) return false;

        country.tours = country.tours.filter(t => t.id !== tourId);
        return this.setData(data);
    }

    // Content management
    getContent() {
        const data = this.getData();
        return data?.content || {};
    }

    updateContent(contentData) {
        const data = this.getData();
        if (!data) return false;

        if (!data.content) {
            data.content = {};
        }

        data.content = { ...data.content, ...contentData };
        return this.setData(data);
    }

    // Contacts management
    getContacts() {
        const data = this.getData();
        return data?.contacts || {};
    }

    updateContacts(contacts) {
        const data = this.getData();
        if (!data) return false;

        data.contacts = { ...data.contacts, ...contacts };
        return this.setData(data);
    }

    // Settings management
    getSettings() {
        const data = this.getData();
        return data?.settings || {};
    }

    updateSettings(settings) {
        const data = this.getData();
        if (!data) return false;

        data.settings = { ...data.settings, ...settings };
        return this.setData(data);
    }

    // Footer management
    getFooter() {
        const data = this.getData();
        return data?.footer || {};
    }

    updateFooter(footer) {
        const data = this.getData();
        if (!data) return false;

        data.footer = { ...data.footer, ...footer };
        return this.setData(data);
    }

    // Utility methods
    forceRefresh() {
        const data = this.getData();
        if (data) {
            const event = new CustomEvent('worldtravelDataUpdated', { 
                detail: { data: data, force: true }
            });
            window.dispatchEvent(event);
        }
        return data;
    }

    debugData() {
        const data = this.getData();
        console.log('üîç DataManager Debug:', {
            dataExists: !!data,
            countries: data?.countries ? `Array(${data.countries.length})` : 'undefined',
            tours: this.getAllTours().length,
            contacts: data?.contacts,
            lastUpdate: data?.lastUpdate
        });
        return data;
    }

    resetToDefault() {
        const defaultData = this.getDefaultData();
        return this.setData(defaultData);
    }

    repairData() {
        const data = this.getData();
        if (!data) {
            return this.setData(this.getDefaultData());
        }
        
        const defaultData = this.getDefaultData();
        const repairedData = { ...defaultData, ...data };
        
        if (!Array.isArray(repairedData.countries)) {
            repairedData.countries = defaultData.countries;
        }
        
        return this.setData(repairedData);
    }
}

window.dataManager = new DataManager();
console.log('‚úÖ DataManager ready');
