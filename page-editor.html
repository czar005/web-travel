<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор страниц - WorldTravel</title>
    <link rel="stylesheet" href="admin-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .editor-container {
            display: flex;
            height: 100vh;
        }

        .preview-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .editor-panel {
            width: 400px;
            background: white;
            border-left: 2px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 20px;
            background: #2c5aa0;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .preview-frame {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
        }

        .section-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .section-item {
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .section-item:hover {
            border-color: #2c5aa0;
            background: #e3f2fd;
        }

        .section-item.active {
            border-color: #2c5aa0;
            background: #2c5aa0;
            color: white;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .section-desc {
            font-size: 0.9em;
            color: #666;
        }

        .section-item.active .section-desc {
            color: #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .btn-primary {
            background: #2c5aa0;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3d6f;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .stats-editor {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .stat-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .stat-row input {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            color: #ccc;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            background: #28a745;
            color: white;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            border-bottom-color: #2c5aa0;
            background: white;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Левая панель - предпросмотр -->
        <div class="preview-panel">
            <div class="panel-header">
                <h2>Предпросмотр страницы</h2>
                <div>
                    <button class="btn btn-secondary" onclick="refreshPreview()">
                        <i class="fas fa-sync"></i> Обновить
                    </button>
                    <button class="btn btn-primary" onclick="saveAndExit()" style="margin-left: 10px;">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
            </div>
            <iframe class="preview-frame" id="preview-frame" src="index.html?editor=true"></iframe>
        </div>

        <!-- Правая панель - редактор -->
        <div class="editor-panel">
            <div class="panel-header">
                <h2>Редактор контента</h2>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('sections')">Секции</button>
                <button class="tab-button" onclick="showTab('content')">Контент</button>
            </div>

            <div class="panel-content" id="sections-tab">
                <h3 style="margin-bottom: 15px;">Доступные секции</h3>
                <div class="section-list" id="section-list">
                    <!-- Секции будут загружены через JS -->
                </div>
            </div>

            <div class="panel-content" id="content-tab" style="display: none;">
                <div id="content-editor">
                    <div class="empty-state">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>Выберите секцию для редактирования</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SimplePageEditor {
            constructor() {
                this.currentSection = null;
                this.sections = [
                    {
                        id: 'hero',
                        name: 'Главный баннер',
                        description: 'Заголовок и описание на главной странице',
                        fields: [
                            { id: 'title', type: 'text', label: 'Заголовок', selector: '#home h1, .hero h1' },
                            { id: 'subtitle', type: 'textarea', label: 'Описание', selector: '#home p, .hero p' }
                        ]
                    },
                    {
                        id: 'about',
                        name: 'О компании',
                        description: 'Информация о компании и статистика',
                        fields: [
                            { id: 'title', type: 'text', label: 'Заголовок', selector: '#about .section-title, .about .section-title' },
                            { id: 'description', type: 'textarea', label: 'Описание', selector: '.about-text p' },
                            { id: 'stats', type: 'stats', label: 'Статистика' }
                        ]
                    },
                    {
                        id: 'services',
                        name: 'Услуги',
                        description: 'Список услуг компании',
                        fields: [
                            { id: 'title', type: 'text', label: 'Заголовок', selector: '#services .section-title, .services .section-title' }
                        ]
                    },
                    {
                        id: 'destinations',
                        name: 'Направления',
                        description: 'Популярные направления',
                        fields: [
                            { id: 'title', type: 'text', label: 'Заголовок', selector: '#destinations .section-title, .destinations .section-title' },
                            { id: 'subtitle', type: 'textarea', label: 'Подзаголовок', selector: '.destinations .section-subtitle' }
                        ]
                    },
                    {
                        id: 'contact',
                        name: 'Контакты',
                        description: 'Контактная информация',
                        fields: [
                            { id: 'title', type: 'text', label: 'Заголовок', selector: '#contact .section-title, .contact .section-title' },
                            { id: 'phone', type: 'text', label: 'Телефон', selector: '.contact-info .contact-item:nth-child(1) p' },
                            { id: 'email', type: 'text', label: 'Email', selector: '.contact-info .contact-item:nth-child(2) p' },
                            { id: 'address', type: 'text', label: 'Адрес', selector: '.contact-info .contact-item:nth-child(3) p' },
                            { id: 'hours', type: 'text', label: 'Часы работы', selector: '.contact-info .contact-item:nth-child(4) p' }
                        ]
                    }
                ];
                
                this.init();
            }

            init() {
                this.loadSectionsList();
                this.setupFrameListener();
            }

            loadSectionsList() {
                const container = document.getElementById('section-list');
                container.innerHTML = this.sections.map(section => `
                    <div class="section-item" onclick="editor.selectSection('${section.id}')">
                        <div class="section-title">${section.name}</div>
                        <div class="section-desc">${section.description}</div>
                    </div>
                `).join('');
            }

            setupFrameListener() {
                const frame = document.getElementById('preview-frame');
                frame.onload = () => {
                    console.log('Preview frame loaded');
                    // Можно добавить дополнительную инициализацию здесь
                };
            }

            selectSection(sectionId) {
                // Убираем активный класс у всех секций
                document.querySelectorAll('.section-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Добавляем активный класс выбранной секции
                const selectedItem = document.querySelector(`[onclick="editor.selectSection('${sectionId}')"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }

                this.currentSection = this.sections.find(s => s.id === sectionId);
                this.showContentEditor();
                this.showTab('content');
            }

            showContentEditor() {
                if (!this.currentSection) return;

                const editor = document.getElementById('content-editor');
                const frame = document.getElementById('preview-frame');
                const frameDoc = frame.contentDocument || frame.contentWindow.document;

                let editorHTML = `<h3 style="margin-bottom: 20px;">${this.currentSection.name}</h3>`;

                this.currentSection.fields.forEach(field => {
                    if (field.type === 'stats') {
                        editorHTML += this.getStatsEditor();
                    } else {
                        const currentValue = this.getCurrentValue(frameDoc, field.selector);
                        editorHTML += `
                            <div class="form-group">
                                <label>${field.label}:</label>
                                ${field.type === 'textarea' ? 
                                    `<textarea class="form-control" data-field="${field.id}" data-selector="${field.selector}">${currentValue}</textarea>` :
                                    `<input type="text" class="form-control" data-field="${field.id}" data-selector="${field.selector}" value="${currentValue}">`
                                }
                            </div>
                        `;
                    }
                });

                editorHTML += `
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="editor.saveChanges()">
                            <i class="fas fa-save"></i> Применить изменения
                        </button>
                        <button class="btn btn-secondary" onclick="showTab('sections')">
                            <i class="fas fa-arrow-left"></i> Назад к списку
                        </button>
                    </div>
                `;

                editor.innerHTML = editorHTML;
            }

            getStatsEditor() {
                const frame = document.getElementById('preview-frame');
                const frameDoc = frame.contentDocument || frame.contentWindow.document;
                
                // Получаем текущую статистику
                const stats = [];
                const statElements = frameDoc.querySelectorAll('.stat, .about .stat');
                
                if (statElements.length > 0) {
                    statElements.forEach(stat => {
                        const value = stat.querySelector('h3')?.textContent || '';
                        const label = stat.querySelector('p')?.textContent || '';
                        stats.push({ value, label });
                    });
                } else {
                    // Стандартная статистика
                    stats.push(
                        { value: '5000', label: 'Довольных клиентов' },
                        { value: '50', label: 'Стран мира' },
                        { value: '10 лет', label: 'Опыта работы' }
                    );
                }

                let statsHTML = '<div class="form-group"><label>Статистика:</label><div class="stats-editor">';
                
                stats.forEach((stat, index) => {
                    statsHTML += `
                        <div class="stat-row">
                            <input type="text" class="form-control" data-stat-value="${index}" 
                                   value="${stat.value}" placeholder="Значение">
                            <input type="text" class="form-control" data-stat-label="${index}" 
                                   value="${stat.label}" placeholder="Подпись">
                        </div>
                    `;
                });

                statsHTML += '</div></div>';
                return statsHTML;
            }

            getCurrentValue(frameDoc, selector) {
                try {
                    const element = frameDoc.querySelector(selector);
                    return element ? element.textContent : '';
                } catch (error) {
                    return '';
                }
            }

            saveChanges() {
                if (!this.currentSection) return;

                const frame = document.getElementById('preview-frame');
                const frameDoc = frame.contentDocument || frame.contentWindow.document;

                try {
                    // Сохраняем обычные поля
                    this.currentSection.fields.forEach(field => {
                        if (field.type !== 'stats') {
                            const input = document.querySelector(`[data-field="${field.id}"]`);
                            if (input && field.selector) {
                                const element = frameDoc.querySelector(field.selector);
                                if (element) {
                                    element.textContent = input.value;
                                }
                            }
                        }
                    });

                    // Сохраняем статистику
                    this.saveStatsChanges(frameDoc);

                    // Сохраняем в dataManager
                    this.saveToDataManager();

                    this.showNotification('Изменения успешно применены!');
                    
                } catch (error) {
                    console.error('Error saving changes:', error);
                    this.showNotification('Ошибка при сохранении изменений', 'error');
                }
            }

            saveStatsChanges(frameDoc) {
                const stats = [];
                for (let i = 0; i < 3; i++) {
                    const valueInput = document.querySelector(`[data-stat-value="${i}"]`);
                    const labelInput = document.querySelector(`[data-stat-label="${i}"]`);
                    
                    if (valueInput && labelInput && valueInput.value && labelInput.value) {
                        stats.push({
                            value: valueInput.value,
                            label: labelInput.value
                        });
                    }
                }

                // Обновляем статистику на странице
                const statElements = frameDoc.querySelectorAll('.stat, .about .stat');
                statElements.forEach((stat, index) => {
                    const valueEl = stat.querySelector('h3');
                    const labelEl = stat.querySelector('p');
                    
                    if (valueEl && stats[index]) valueEl.textContent = stats[index].value;
                    if (labelEl && stats[index]) labelEl.textContent = stats[index].label;
                });

                // Сохраняем в dataManager
                if (window.dataManager) {
                    window.dataManager.updateStats(stats);
                }
            }

            saveToDataManager() {
                if (!window.dataManager) return;

                const frame = document.getElementById('preview-frame');
                const frameDoc = frame.contentDocument || frame.contentWindow.document;
                const content = window.dataManager.getContent() || {};

                // Обновляем контент на основе текущих значений
                if (this.currentSection.id === 'hero') {
                    content.hero = {
                        title: frameDoc.querySelector('#home h1, .hero h1')?.textContent || '',
                        subtitle: frameDoc.querySelector('#home p, .hero p')?.textContent || ''
                    };
                } else if (this.currentSection.id === 'about') {
                    content.about = {
                        title: frameDoc.querySelector('#about .section-title')?.textContent || '',
                        description: frameDoc.querySelector('.about-text p')?.textContent || ''
                    };
                }

                window.dataManager.updateContent(this.currentSection.id, content[this.currentSection.id]);
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.background = type === 'error' ? '#dc3545' : '#28a745';
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 3000);
            }
        }

        // Глобальные функции
        function showTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.panel-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Показываем выбранную вкладку
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Обновляем активные кнопки
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function refreshPreview() {
            const frame = document.getElementById('preview-frame');
            frame.src = frame.src;
        }

        function saveAndExit() {
            if (editor.currentSection) {
                editor.saveChanges();
            }
            setTimeout(() => {
                window.location.href = 'admin.html';
            }, 1000);
        }

        // Инициализация редактора
        const editor = new SimplePageEditor();

        // Авто-фокус на первую секцию
        setTimeout(() => {
            const firstSection = document.querySelector('.section-item');
            if (firstSection) {
                firstSection.click();
            }
        }, 1000);
    </script>
</body>
</html>
